<!doctype html>
<!-- Website template by freewebsitetemplates.com -->
<!-- Iterate.html - each successive page in the wizard, until we reach the end.
Thanks to W3Schools docs, and especially the following:
 * http://stackoverflow.com/questions/2015065/how-does-one-do-async-ajax-calls-using-cherrypy

TODO
 * Have the generator store the current state in the # component of the url, in case of bookmarking,
   then read the # on page load and change settings boxes appropriately.
 -->
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Printer Evaluation Model Generator</title>
    <link rel="stylesheet" href="static/external/jquery-ui-1.11.4.custom/jquery-ui.css" type="text/css">
    <link rel="stylesheet" href="static/css/style.css" type="text/css">
    <script src="static/external/jquery.js" type="text/javascript"></script>
    <script src="static/external/jquery-ui-1.11.4.custom/jquery-ui.js" type="text/javascript"></script>
    <script src="static/js/util.js" type="text/javascript"></script>

    <script>
        $(document).ready(function () {
            var col_thresh = 0;
            var bar_thresh = 0;
            var col_zoom = 7;
            var bar_zoom = 7;

            // Parse the information after the hash in the url and load it into the ref_part_params variable
            var ref_part_params = parseUrl();

            $("#layer_height").html(ref_part_params.layer_height.toString());

            // Load resource images into the img-cache div hidden at the bottom of the page
            var template1 = '<img id="partN-columns#" src="static/images/partN-columns#.png" width="220" height="220">';
            var template2 = '<img id="partN-bars#" src="static/images/partN-bars#.png" width="220" height="220">';
            var new_html = '';
            for(var i = 0; i < 11; i++) {
                new_html += template1.replace(/#/g, i.toString()) + template2.replace(/#/g, i.toString());
            }
            $("#img-cache").html(new_html);

            // Fill the canvases with initial images
            drawCols();
            drawBars();
            updateText();


            var slCol = $("#col-slider").slider({
                min: 0,
                max: 10,
                range: "min",
                value: 0,
                slide: function (event, ui) {
                    col_thresh = ui.value;
                    drawCols();
                    updateText();
                }
            });

            var slBars = $("#bar-slider").slider({
                min: 0,
                max: 10,
                range: "min",
                value: 0,
                slide: function (event, ui) {
                    bar_thresh = ui.value;
                    drawBars();
                    updateText();
                }
            });

            $("#zoom-bars").spinner({
                change: function(event, ui){
                    bar_zoom = $("#zoom-bars").val();
                    updateText();
                },
                spin: function(event, ui) {
                    bar_zoom = ui.value;
                    updateText()
                }});
            $("#zoom-cols").spinner({
                change: function(event, ui){
                    col_zoom = $("#zoom-cols").val();
                    updateText();
                },
                spin: function(event, ui) {
                    col_zoom = ui.value;
                    updateText()
                }});

            var bGen = $("#generate").button({click: function(event) {
                var res = getResults();     // retrieve the centers of the current target points
                startGenerate(ref_part_params.layer_height, res.new_col_min, res.new_col_max, res.new_bar_min, res.new_bar_max);
            }});

            var bFinish = $("#finish").button({click: function(event) {
                alert("Wizard complete. An option to add relevant comments about setup and material and insert this into the database is a future feature");
            }});

            var bNext = $("#next").button({click: function(event) {
                if (!generated) {
                    if (!confirm("You have not yet generated a test part with these settings. Continue anyway?"))
                        return;
                }
                var new_url = "";
                if((typeof part_params["layer_height"] === "undefined")) {
                    // use the computed next configuration, even though a test part hasn't been generated
                    var res = getResults();
                    new_url = "iterate#" + $.param({
                                "layer_height": ref_part_params.layer_height,
                                "col_min": res.new_col_min,
                                "col_max": res.new_col_max,
                                "bar_min": res.new_bar_min,
                                "bar_max": res.new_bar_max
                            });
                }
                else {
                    // use the characteristics of the actual part generated
                    new_url = "iterate#" + $.param(part_params);
                }

                // Redirect to the new url
                location.href = new_url;
            }});



            function drawCols() {
                // Draws the columns image on the columns canvas
                var canvas = $("#col-canvas")[0];
                var ctx = canvas.getContext("2d");
                var img = $("#partN-columns" + col_thresh.toString())[0];
                // TODO: Clear the canvas?
                ctx.drawImage(img, 0, 0);
            }

            function drawBars() {
                // Draws the columns image on the columns canvas
                var canvas = $("#bar-canvas")[0];
                var ctx = canvas.getContext("2d");
                var img = $("#partN-bars" + bar_thresh.toString())[0];
                // TODO: Clear the canvas?
                ctx.drawImage(img, 0, 0);
            }

            function updateText(){
                // Updates all the text elements on the page when something changes
                var res = getResults();
                $("#col-output").html(smartToString(res.col_center) + "  ± " + smartToString(res.col_error) + " mm");
                $("#bar-output").html(smartToString(res.bar_center) + "  ± " + smartToString(res.bar_error) + " mm");

                $("#new-cols").html(smartToString(res.new_col_min) + " to " + smartToString(res.new_col_max) + " mm");
                $("#new-bars").html(smartToString(res.new_bar_min) + " to " + smartToString(res.new_bar_max) + " mm");
            }




            function getResults() {
                // Returns an object with the following members based on the reference part parameters and
                // the current values of the sliders
                // bar/col_center: The center of the identified characteristic
                // bar/col_error: The approximate error on the identified characteristic
                // new_bar/col_min: If a new test part were generated now, this should be its min
                // new_bar/col_max: '' ...max
                var obj = {};
                obj.bar_center = ref_part_params.bar_min + (ref_part_params.bar_max - ref_part_params.col_min) * (bar_thresh - 0.5) / 10;
                obj.bar_error = (ref_part_params.bar_max - ref_part_params.bar_min) / 5;
                obj.col_center = ref_part_params.col_min + (ref_part_params.col_max - ref_part_params.col_min) * (col_thresh - 0.5) / 10;
                obj.col_error = (ref_part_params.col_max - ref_part_params.col_min) / 5;
                
                // define the new ranges for the bars and columns
                var new_bar_range = (ref_part_params.bar_max - ref_part_params.bar_min) / (bar_zoom);
                var new_col_range = (ref_part_params.col_max - ref_part_params.col_min) / (col_zoom);
                
                obj.new_bar_min = Math.max(0, obj.bar_center - new_bar_range * 0.5);
                obj.new_bar_max = obj.bar_center + new_bar_range * 0.5;
                obj.new_col_min = Math.max(0, obj.col_center - new_col_range * 0.5);
                obj.new_col_max = obj.col_center + new_col_range * 0.5;
                
                return obj;
                
            }

            function parseUrl() {
                // Parses the information after the # in the url and returns it.
                var params = QueryStringToHash(window.location.hash.substring(1));
                // check for validity of the hash contents
                if (typeof params.layer_height === "undefined" || typeof params.col_min === "undefined" ||
                        typeof params.col_max === "undefined" || typeof params.bar_min === "undefined" ||
                        typeof params.bar_max === "undefined") {
                    alert("URL missing parameters. Please use your browser's Back button to re-generate this page.");
                    // so we don't break anything, add defaults
                    ref_part_params = {"layer_height": 0.2, "col_min": 0.1, "col_max": 1, "bar_min": 0.1, "bar_max": 1};
                }
                // convert elements to numbers
                params.layer_height = Number(params.layer_height);
                params.col_min = Number(params.col_min);
                params.col_max = Number(params.col_max);
                params.bar_min = Number(params.bar_min);
                params.bar_max = Number(params.bar_max);
                
                return params;
            }


        });
    </script>
</head>
<body>
<div id="page">
    <div id="header">
        <div>
            <a href="index" class="logo"><img src="static/images/logo.png" alt=""></a>
            <ul id="navigation">
                <li class="selected">
                    <a href="index">Home</a>
                </li>
                <li class="menu">
                    <a href="static/help.html">Help</a>
                </li>
            </ul>
        </div>
    </div>
    <div id="body" class="home">
        <img class="bigimage" src="static/images/part1.png" style="width:250px">
        <div class="bodytext">
            <h1>Printer Qualification Wizard</h1>
            <p>Look at the test part you printed in the previous step. The model contained 10 bars and 10 columns,
                but your printer probably didn't correctly reproduce all ten (if it did, that's OK!). In this
                step, we will use the results of which bars did and didn't print to define a new test part that will
                "zoom in" on your printer's capability.
            </p>
            <br/>
            <p>
                This qualification run is using <span id="layer_height">0</span> for layer height. Please do not change
                the layer height for successive prints.
            </p>
            <br/>
            <div id="sections">
                <h3 class="section-head">Columns</h3>
                <div class="section-body">
                    <canvas id="col-canvas" width="220" height="220"></canvas>
                    <div class="subsec-left-col">
                        <p>This image is representative; your part may looks slightly different.</p>
                        <br/>
                        <p>Use the slider to indicate how many columns printed acceptably.</p>
                        <br/>
                        <div id="col-slider" style="margin-left: 1em"></div>
                    </div>
                </div>
                <h3 class="section-head">Bars</h3>
                <div class="section-body">
                    <canvas id="bar-canvas" width="220" height="220"></canvas>
                    <div style="float: left; max-width: 50%;">
                        <p>This image is representative; your part may looks slightly different.</p>
                        <br/>
                        <p>Use the slider to indicate how many bars printed acceptably.</p>
                        <br/>
                        <div id="bar-slider" style="margin-left: 1em"></div>
                    </div>
                </div>
            </div>

            <br/>

            <h3>Current Results</h3>
            <p>Based on the results so far, your machine achieves the following print characteristics:</p>
            <br/>
            <div class="indent">
                <p style="font-size: 18px">
                    Minimum Column Size: <span id="col-output"></span>
                <br/>
                    Minimum Bar Size: <span id="bar-output"></span>
                </p>
            </div>
            <br/>
            <h3>Keep Iterating?</h3>
            <p>Do you want to generate a new part, zooming in on the failure threshold?</p>
            <button class="button" id="generate" style="float: none; margin-left: 4em">
                <span class="ui-button-text">Generate Part</span>
            </button>
            <button class="button" id="finish" style="float: none; margin-left: 6em">
                <span class="ui-button-text">I'm Done</span>
            </button>
            <br/>
            <h3 class="section-head">Generation Options</h3>
            <div class="section-body">
                <p>Zoom Factor: Ratio by which the (max - min) range is scaled around the failure point</p>
                <div class="indent">
                    <table>
                        <tr>
                            <td>Column Zoom:</td>
                            <td>
                                <input class="inputbox" id="zoom-cols" name="zoom-cols" value="7" min="0.5" max="10"
                                       step="0.5" pattern="([0-9]*\.?[0-9]+)|([0-9]+\.)">
                            </td>

                        </tr>
                        <tr>
                            <td>Bar Range:</td>
                            <td>
                                <input class="inputbox" id="zoom-bars" name="zoom-bars" value="7" min="0.5" max="10"
                                       step="0.5" pattern="([0-9]*\.?[0-9]+)|([0-9]+\.)">
                            </td>
                        </tr>
                    </table>
                </div>
                <p>Zoom factor of 1 means no change; 10 means zoom so the whole bar range is spread in the difference
                    between two bars. Values less than 1 zoom out.</p>
                <br/>
                <p>Right now, the new test part would have the following settings:</p>
                <div class="indent">
                    <p>Columns: <span id="new-cols"></span></p>
                    <p>Bars: <span id="new-bars"></span></p>
                </div>
            </div>
            <p>
            </p>
            <div id="progress-area">
                <p id="message">Generating part...<span id="status"></span></p>
                <div id="progressbar"></div>
            </div>
            <br/>
            <p>Go print this part, then click Next to evaluate the results.</p>
            <button class="button" id="next">
                <span class="ui-button-text">Next</span>
            </button>

        </div>
    </div>
</div>
<div id="footer">
    <div>
        <p>&copy; 2016 Ben Weiss; University of Washington</p>
    </div>
</div>
<div id="img-cache" style="display: none">

</div>
</body>
</html>
